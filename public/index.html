<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OWO Farm Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .xterm-viewport { overflow-y: auto !important; }
        input, textarea { font-size: 16px !important; }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .select-tag input:checked + div {
            background-color: #7c3aed;
            border-color: #8b5cf6;
            color: white;
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { darkbg: '#0f172a', darkcard: '#1e293b', darklighter: '#334155' } } }
        }
    </script>
</head>
<body class="bg-darkbg text-gray-200 font-sans h-[100dvh] flex flex-col md:flex-row overflow-hidden">

    <header class="h-12 bg-darkcard border-b border-gray-700 flex items-center justify-between px-4 shrink-0 md:hidden z-20">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-robot text-purple-500"></i>
            <span class="font-bold tracking-wider text-sm">OWO FARM</span>
        </div>
        <div id="status-badge-mobile" class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-800 text-gray-400 border border-gray-700">LOADING...</div>
    </header>

    <aside class="hidden md:flex w-64 bg-darkcard border-r border-gray-700 flex-col shrink-0">
        <div class="p-6 flex items-center gap-3 border-b border-gray-700">
            <i class="fa-solid fa-robot text-purple-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wider">OWO CONTROL</h1>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 bg-gray-700 font-medium" data-tab="dashboard">
                <i class="fa-solid fa-terminal w-6 text-center"></i> Console
            </button>
            <button onclick="switchTab('config')" class="nav-item w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition flex items-center gap-3 font-medium" data-tab="config">
                <i class="fa-solid fa-gears w-6 text-center"></i> Cấu hình
            </button>
        </nav>
        <div class="p-4 border-t border-gray-700">
            <div id="status-badge-desktop" class="flex items-center justify-center gap-2 px-3 py-3 rounded bg-gray-800 text-gray-400 border border-gray-700 font-bold transition-all text-sm">
                <div class="w-2 h-2 rounded-full bg-gray-500"></div> CONNECTING...
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-black">
        
        <div id="tab-dashboard" class="flex flex-col h-full absolute inset-0 z-10 bg-black">
            <div class="p-2 md:p-4 bg-darkcard border-b border-gray-800 shrink-0 flex gap-2">
                <button id="btn-start" class="flex-1 py-2 bg-green-600 hover:bg-green-700 rounded font-bold shadow text-white text-sm flex justify-center gap-2 items-center"><i class="fa-solid fa-play"></i> START</button>
                <button id="btn-stop" class="flex-1 py-2 bg-red-600 hover:bg-red-700 rounded font-bold shadow text-white opacity-50 cursor-not-allowed text-sm flex justify-center gap-2 items-center" disabled><i class="fa-solid fa-power-off"></i> STOP</button>
            </div>
            <div id="terminal-container" class="flex-1 bg-black overflow-hidden relative w-full h-full"></div>
            <div class="bg-gray-900 border-t border-gray-700 p-2 flex gap-2 items-center shrink-0 mb-safe pb-safe">
                <span class="text-green-500 font-bold hidden md:block px-2">input></span>
                <input type="text" id="console-input" class="flex-1 bg-darkbg border border-gray-600 rounded px-3 py-2 text-white focus:border-purple-500 focus:outline-none placeholder-gray-500 text-sm" placeholder="Nhập lệnh / Chọn Acc..." autocomplete="off">
                <button id="btn-send-cmd" class="bg-gray-700 text-white px-4 py-2 rounded font-bold text-sm">GỬI</button>
            </div>
            <div class="h-14 md:hidden shrink-0 bg-darkcard"></div>
        </div>

        <div id="tab-config" class="hidden flex flex-col h-full absolute inset-0 bg-darkbg z-10">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-darkcard z-20 sticky top-0 shrink-0 shadow-md">
                <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-sliders mr-2 text-purple-500"></i>Cài đặt</h2>
                <button id="btn-save" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold shadow text-sm flex items-center gap-2 text-white transition-all transform active:scale-95">
                    <i class="fa-solid fa-floppy-disk"></i> LƯU
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 pb-24 bg-darkbg">
                <div id="config-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

    </main>

    <nav class="md:hidden fixed bottom-0 left-0 w-full bg-darkcard border-t border-gray-700 flex justify-around items-center h-14 z-50 pb-safe">
        <button onclick="switchTab('dashboard')" class="nav-item-mobile flex flex-col items-center justify-center w-full h-full text-purple-400" data-tab="dashboard">
            <i class="fa-solid fa-terminal text-lg mb-0.5"></i> <span class="text-[10px] font-bold">Console</span>
        </button>
        <button onclick="switchTab('config')" class="nav-item-mobile flex flex-col items-center justify-center w-full h-full text-gray-500" data-tab="config">
            <i class="fa-solid fa-gears text-lg mb-0.5"></i> <span class="text-[10px] font-bold">Config</span>
        </button>
    </nav>

    <script>
        const socket = io();
        let botRunning = false;

        // --- CẤU HÌNH CÁC TAGS (Bạn có thể thêm bớt tùy ý) ---
        const PRESETS = {
            "gemtier": ["common", "uncommon", "rare", "epic", "mythical", "legendary", "fabled"],
            "autopray": ["pray", "curse"],
            "autotrait": ["gain", "skip", "wait"], 
            "autoquote": ["owo", "uwu"],
            "channelID": [], 
        };

        // --- XTERM SETUP ---
        const term = new Terminal({ cursorBlink: true, theme: { background: '#000000' }, fontFamily: 'monospace', fontSize: 13, convertEol: true, disableStdin: true, rows: 30 });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        setTimeout(() => fitAddon.fit(), 100);
        window.addEventListener('resize', () => fitAddon.fit());

        // --- ELEMENTS ---
        const configContainer = document.getElementById('config-container');
        const statusBadgeDesktop = document.getElementById('status-badge-desktop');
        const statusBadgeMobile = document.getElementById('status-badge-mobile');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');

        // --- NAVIGATION ---
        function switchTab(tabName) {
            document.getElementById('tab-dashboard').classList.add('hidden');
            document.getElementById('tab-config').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.toggle('bg-gray-700', el.dataset.tab === tabName);
                el.classList.toggle('text-white', el.dataset.tab === tabName);
                el.classList.toggle('text-gray-400', el.dataset.tab !== tabName);
            });
            document.querySelectorAll('.nav-item-mobile').forEach(el => {
                el.classList.toggle('text-purple-400', el.dataset.tab === tabName);
                el.classList.toggle('text-gray-500', el.dataset.tab !== tabName);
            });
            if (tabName === 'dashboard') setTimeout(() => fitAddon.fit(), 100);
        }

        // --- RENDER CONFIG ---
        function renderConfig(config) {
            configContainer.innerHTML = '';
            const mainSettings = {};
            const objectSettings = {};

            for (const key in config) {
                if (typeof config[key] === 'object' && config[key] !== null && !Array.isArray(config[key])) {
                    objectSettings[key] = config[key];
                } else {
                    mainSettings[key] = config[key];
                }
            }

            if (Object.keys(mainSettings).length > 0) configContainer.appendChild(createCard('Cài đặt chung', 'fa-sliders', mainSettings, ''));
            for (const key in objectSettings) {
                let icon = 'fa-box';
                if (key.toLowerCase().includes('gamble')) icon = 'fa-dice';
                if (key.toLowerCase().includes('inventory')) icon = 'fa-backpack';
                configContainer.appendChild(createCard(key.toUpperCase(), icon, objectSettings[key], key + '.'));
            }
        }

        function createCard(title, iconClass, dataObj, prefix) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'bg-darkcard rounded-xl border border-gray-700 shadow-lg overflow-hidden flex flex-col';
            
            const header = document.createElement('div');
            header.className = 'bg-darklighter px-4 py-3 border-b border-gray-700 flex items-center gap-2';
            header.innerHTML = `<i class="fa-solid ${iconClass} text-purple-400"></i> <span class="font-bold text-sm tracking-wide text-gray-200">${title}</span>`;
            cardDiv.appendChild(header);

            const body = document.createElement('div');
            body.className = 'p-4 space-y-4 flex-1';

            for (const key in dataObj) {
                const val = dataObj[key];
                const fullKey = prefix + key;
                const lowerKey = key.toLowerCase(); 

                const itemRow = document.createElement('div');
                const labelDiv = document.createElement('div');
                labelDiv.className = 'text-xs font-bold text-gray-400 uppercase mb-1 flex justify-between items-center';
                labelDiv.innerText = key;
                
                if (typeof val === 'boolean') {
                    itemRow.className = 'flex justify-between items-center py-1';
                    itemRow.innerHTML = `
                        <span class="text-xs md:text-sm font-medium text-gray-300 uppercase">${key}</span>
                        <label class="flex items-center cursor-pointer relative">
                            <input type="checkbox" id="${fullKey}" class="sr-only peer" ${val ? 'checked' : ''} data-type="bool">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                        </label>`;
                
                } else if (Array.isArray(val) && PRESETS[lowerKey]) {
                    itemRow.appendChild(labelDiv);
                    const tagsContainer = document.createElement('div');
                    tagsContainer.className = 'flex flex-wrap gap-2 mt-1';
                    tagsContainer.id = fullKey; 
                    tagsContainer.setAttribute('data-type', 'tag-group');

                    PRESETS[lowerKey].forEach(option => {
                        const isSelected = val.includes(option);
                        const tagLabel = document.createElement('label');
                        tagLabel.className = 'select-tag cursor-pointer';
                        tagLabel.innerHTML = `
                            <input type="checkbox" class="hidden" value="${option}" ${isSelected ? 'checked' : ''}>
                            <div class="px-3 py-1.5 rounded-md bg-darkbg border border-gray-600 text-xs font-medium text-gray-400 transition-all hover:border-gray-400 select-none">
                                ${option}
                            </div>`;
                        tagsContainer.appendChild(tagLabel);
                    });
                    itemRow.appendChild(tagsContainer);

                } else if (Array.isArray(val)) {
                    itemRow.className = 'py-1'; itemRow.appendChild(labelDiv);
                    const input = document.createElement('input');
                    input.type = 'text'; input.id = fullKey; input.value = JSON.stringify(val);
                    input.className = 'w-full bg-darkbg border border-gray-600 rounded px-2 py-2 text-xs text-white focus:border-purple-500 outline-none font-mono';
                    input.setAttribute('data-type', 'array');
                    itemRow.appendChild(input);

                } else {
                    itemRow.className = 'py-1'; itemRow.appendChild(labelDiv);
                    const input = document.createElement('input');
                    input.type = typeof val === 'number' ? 'number' : 'text';
                    input.id = fullKey; input.value = val;
                    input.className = 'w-full bg-darkbg border border-gray-600 rounded px-2 py-2 text-sm text-white focus:border-purple-500 outline-none';
                    input.setAttribute('data-type', typeof val === 'number' ? 'number' : 'string');
                    itemRow.appendChild(input);
                }
                body.appendChild(itemRow);
            }
            cardDiv.appendChild(body);
            return cardDiv;
        }

        // --- SAVE CONFIG LOGIC ---
        document.getElementById('btn-save').addEventListener('click', () => {
            fetch('/api/data').then(r => r.json()).then(d => {
                const newConfig = { ...d.config };
                const inputs = document.querySelectorAll('input[id]');
                inputs.forEach(input => {
                    if(input.closest('[data-type="tag-group"]')) return;
                    const fullKey = input.id;
                    const type = input.getAttribute('data-type');
                    let value;
                    if (type === 'bool') value = input.checked;
                    else if (type === 'number') value = Number(input.value);
                    else if (type === 'array') { try { value = JSON.parse(input.value); } catch { value = input.value.split(','); } }
                    else value = input.value;
                    applyValue(newConfig, fullKey, value);
                });

                const tagGroups = document.querySelectorAll('[data-type="tag-group"]');
                tagGroups.forEach(group => {
                    const fullKey = group.id;
                    const selectedValues = [];
                    group.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => selectedValues.push(cb.value));
                    applyValue(newConfig, fullKey, selectedValues);
                });

                fetch('/api/config', {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(newConfig)
                }).then(() => alert('Đã lưu cấu hình thành công!'));
            });
        });

        function applyValue(configObj, fullKey, value) {
            if (fullKey.includes('.')) {
                const [parent, child] = fullKey.split('.');
                if (!configObj[parent]) configObj[parent] = {};
                configObj[parent][child] = value;
            } else {
                configObj[fullKey] = value;
            }
        }

        // --- INIT & SOCKET ---
        fetch('/api/data').then(r => r.json()).then(d => { renderConfig(d.config); updateStatusUI(d.status === 'running'); });
        socket.on('log', (msg) => term.write(msg));
        socket.on('history', (msg) => { term.clear(); term.write(msg); });
        socket.on('status', (s) => updateStatusUI(s === 'running'));

        function updateStatusUI(isRunning) {
            const text = isRunning ? 'RUNNING' : 'STOPPED';
            const colorClass = isRunning ? 'text-green-400 bg-green-900/30 border-green-900' : 'text-red-400 bg-red-900/30 border-red-900';
            statusBadgeMobile.innerText = text; statusBadgeMobile.className = `text-[10px] font-bold px-2 py-0.5 rounded border ${colorClass}`;
            statusBadgeDesktop.innerHTML = `<div class="w-2 h-2 rounded-full ${isRunning ? 'bg-green-500 animate-pulse' : 'bg-red-500'}"></div> ${text}`;
            statusBadgeDesktop.className = `flex items-center justify-center gap-2 px-3 py-3 rounded border font-bold transition-all text-sm ${colorClass}`;
            btnStart.disabled = isRunning; btnStart.classList.toggle('opacity-50', isRunning);
            btnStop.disabled = !isRunning; btnStop.classList.toggle('opacity-50', !isRunning);
        }

        // --- CONTROL BUTTONS EVENTS (Đã thêm lại) ---
        btnStart.addEventListener('click', () => {
            fetch('/api/control', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'start'})});
        });
        btnStop.addEventListener('click', () => fetch('/api/control', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'stop'})}));

        const consoleInput = document.getElementById('console-input');
        const sendCmd = () => { fetch('/api/input', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({command: consoleInput.value}) }); consoleInput.value = ''; consoleInput.focus(); };
        document.getElementById('btn-send-cmd').addEventListener('click', sendCmd);
        consoleInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendCmd(); });
    </script>
</body>
</html>

